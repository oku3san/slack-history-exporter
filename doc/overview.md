# Slackの履歴エクスポートツール仕様書

## 1. プロジェクト概要

`slack-history-exporter`は、Slack上の会話履歴をエクスポートするためのコマンドラインツールです。このツールは、指定されたSlackチャンネルからメッセージ履歴を取得し、ローカルにエクスポートできます。

## 2. 機能要件

### 2.1 主要機能
- Slackのチャンネル履歴をエクスポート
- コマンドライン引数による操作
- 環境変数によるユーザートークン認証

### 2.2 詳細機能
1. **認証機能**
    - SlackのユーザートークンによるAPI認証
    - トークンは環境変数から取得

2. **履歴取得機能**
    - 指定チャンネルのメッセージ履歴取得
    - ページネーション対応（大量メッセージの取得）
    - スレッドコメントの取得

3. **エクスポート機能**
    - JSON形式でのエクスポート
    - ファイル名のカスタマイズ対応
    - メッセージのタイムスタンプ変換

4. **エラーハンドリング**
    - API制限の対応
    - 認証エラー処理
    - 無効なチャンネル指定時のエラーメッセージ

## 3. 技術仕様

### 3.1 開発言語・環境
- 開発言語: Go 1.24
- 依存ライブラリ:
    - Slack API クライアントライブラリ
    - コマンドライン引数解析ライブラリ

### 3.2 アーキテクチャ
- コマンドラインインターフェース
- Slack API クライアント
- エクスポーターモジュール
- ファイル出力モジュール

### 3.3 APIエンドポイント
- `conversations.history` - チャンネルの履歴取得
- `conversations.replies` - スレッドの返信取得

## 4. 環境変数とコマンドライン引数

### 環境変数
- `SLACK_TOKEN`: Slackのユーザートークン（**必須**）

### コマンドライン引数
```bash
slack-history-exporter --channel <チャンネルID> [オプション]
```


### 必須引数
- `--channel`, `-c`: エクスポート対象のチャンネルID

### オプション引数
- `--output`, `-o`: 出力ファイル名（デフォルト: `{チャンネル名}_{日付}.json`）
- `--format`, `-f`: 出力フォーマット（デフォルト: `json`、オプション: `csv`）
- `--days`, `-d`: 取得する日数（デフォルト: 全履歴）
- `--include-threads`, `-i`: スレッド返信も取得（デフォルト: `true`）
- `--verbose`, `-v`: 詳細ログの出力
- `--help`, `-h`: ヘルプ表示

## 5. 出力フォーマット

### JSONフォーマット
```json
{
  "channel_id": "C12345678",
  "channel_name": "general",
  "export_date": "2023-07-01T12:34:56Z",
  "messages": [
    {
      "message_id": "1656789012.123456",
      "user": "U12345678",
      "user_name": "username",
      "text": "メッセージ内容",
      "timestamp": "2023-06-30T09:12:34Z",
      "reactions": [...],
      "thread_replies": [...]
    },
    ...
  ]
}
```

## 6. エラー処理

- 環境変数未設定: トークン未設定のエラーメッセージを表示して終了
- 無効なトークン: エラーメッセージを表示して終了
- 無効なチャンネル: エラーメッセージを表示して終了
- API制限: エクスポネンシャルバックオフ戦略で待機し再試行
- その他のエラー: エラーログを表示して終了

## 7. セキュリティ

- トークンは環境変数のみから取得する設計とし、コマンドラインからの入力は受け付けない
- ログ出力時にトークン情報は隠蔽

## 8. 制限事項

- Slack APIの制限により大量のリクエストには制限がかかる場合あり
- ユーザートークンは個人のアクセス権限に依存するため、アクセスできないチャンネルの履歴は取得不可
- ファイル添付のダウンロードは別途対応が必要

## 9. 今後の拡張性

- 複数チャンネルの一括エクスポート機能
- 特定期間のメッセージのみエクスポートする機能
- ファイル添付のダウンロード機能
- ワークスペース全体のエクスポート機能
- 差分エクスポート機能

## 10. 開発ロードマップ

1. 基本的なチャンネル履歴取得機能
2. JSONエクスポート機能
3. スレッド返信取得機能
4. 日時指定機能
5. CSVエクスポート機能
6. ファイル添付処理

## 11. 使用例

```bash
# 環境変数の設定
export SLACK_TOKEN="xoxp-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx"

# 基本的な使用法
slack-history-exporter -c C12345678

# 出力先を指定
slack-history-exporter -c C12345678 -o my-export.json

# 最近7日分のみエクスポート
slack-history-exporter -c C12345678 -d 7

# CSVフォーマットでエクスポート
slack-history-exporter -c C12345678 -f csv
```